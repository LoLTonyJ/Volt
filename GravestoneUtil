package me.tony.main.voltnetwork.GravestoneUtil;

import eu.decentsoftware.holograms.api.DHAPI;
import me.tony.main.voltnetwork.VoltNetwork;
import org.bukkit.ChatColor;
import org.bukkit.Location;
import org.bukkit.Material;
import org.bukkit.block.Block;
import org.bukkit.entity.Player;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.event.entity.PlayerDeathEvent;
import org.bukkit.event.inventory.InventoryClickEvent;
import org.bukkit.event.inventory.InventoryCloseEvent;
import org.bukkit.event.player.PlayerInteractEvent;
import org.bukkit.inventory.Inventory;
import org.bukkit.inventory.PlayerInventory;

import java.util.HashMap;

public class Gravestones implements Listener {

    Boolean sendTitle = VoltNetwork.getInstance().getConfig().getBoolean("sendtitle_gravestone_coords");
    String titleHeader = VoltNetwork.getInstance().getConfig().getString("sendtitle_header");
    String titleFooter = VoltNetwork.getInstance().getConfig().getString("sendtitle_footer");
    Boolean sendMessage = VoltNetwork.getInstance().getConfig().getBoolean("sendmessage_gravestone_coords");
    String message = VoltNetwork.getInstance().getConfig().getString("gravestone_coords_message");

    public static HashMap<Player, Material> RemoveGrave = new HashMap<>();
    public static HashMap<Player, Double> BlockLoc = new HashMap<>();
    public static HashMap<Player, Location> Gravestone = new HashMap<>();

    public static HashMap<Player, Integer> XCoord = new HashMap<>();
    public static HashMap<Player, Integer> YCoord = new HashMap<>();
    public static HashMap<Player, Integer> ZCoord = new HashMap<>();


    @EventHandler
    public void onDeath(PlayerDeathEvent e) {

        Player p = e.getEntity().getPlayer();
        Location pLoc = p.getLocation();
        String GraveBlock = VoltNetwork.getInstance().getConfig().getString("block_type");
        Boolean graveEnable = VoltNetwork.getInstance().getConfig().getBoolean("gravestone_enable");

        if (graveEnable.equals(false)) return;

        if (p.getInventory().getContents() != null) {

            int x = (int) p.getLocation().getX();
            int y = (int) p.getLocation().getY();
            int z = (int) p.getLocation().getZ();

            XCoord.put(p, x);
            YCoord.put(p, y);
            ZCoord.put(p, z);

            // Clears Drops.
            e.getDrops().clear();

            // Storing Location of Player Death
            Gravestone.put(p, pLoc);

            // Storing Players Inventory on Death.
            StoreItems.StoreOnDeath(p);

            // Getting the block at the location the player died at.
            pLoc.getBlock().setType(Material.valueOf(GraveBlock));

            // Storing the block location into a map.
            BlockLoc.put(p, pLoc.getBlock().getLocation().getX());

            System.out.println(BlockLoc.get(p)); // debugging
            // Spawning a Hologram.
            StoreItems.Hologram(p, Gravestone.get(p).add(0, 3, 0));

            // Storing the block
            RemoveGrave.put(p, Material.valueOf(GraveBlock));
        }
    }

    @EventHandler
    public void onClose(InventoryCloseEvent e) {

        Inventory i = e.getInventory();
        Player p = (Player) e.getPlayer();


        if (e.getView().getTitle().equals(ChatColor.translateAlternateColorCodes('&', "&c&l" + e.getPlayer().getName() + "'s Gravestone"))) {
            // Checks if the Gravestone Inventory is empty
            if (i.isEmpty()) {
                // Removes the created Hologram
                DHAPI.removeHologram(p.getName());
                // Removes player from Gravestone Map
                StoreItems.SaveInv.remove(e.getPlayer());
            }
        }
    }

    @EventHandler
    public void GravestoneClaim(PlayerInteractEvent e) {
        Player p = e.getPlayer();
        Block b = e.getClickedBlock();
        String GraveBlock = VoltNetwork.getInstance().getConfig().getString("block_type");

        // Basic Checks to reduce errors in console.
        if (!BlockLoc.containsKey(p)) return;
        if (!StoreItems.SaveInv.containsKey(p)) return;
        if (b == null) return;

        // Checks for the block type supplied in config.
        if (b.getType().equals(Material.valueOf(GraveBlock))) {
            // Checks the location (Checks for X) to see if the player is the owner of the gravestone
            if (b.getLocation().getX() == BlockLoc.get(p)) {
                // Cancels Event
                e.setCancelled(true);
                // Opens Gravestone
                StoreItems.DeathInv(p);
                // Removes Gravestone
                b.setType(Material.AIR);
            } else {

                // If the player doesn't own the gravestone and is included into the list.
                // Cancel the event, and run code.
                e.setCancelled(true);

                // If both sendtitle_### and sendmessage_ are false, return; Do Nothing.
                if (!sendTitle && !sendMessage) return;

                // If sendtitle_gravestone_coords is true in config, send the player the title.
                if (sendTitle) {
                    // Checking the String for %coords%, if the String contains keyword, replace with X,Y,Z
                    if (titleFooter.contains("%coords%")) {
                        String placeholder = titleFooter.replace("%coords%", "X " + XCoord.get(p) + " Z " + ZCoord.get(p) + " Y " + YCoord.get(p));
                        p.sendTitle(ChatColor.translateAlternateColorCodes('&', titleHeader), ChatColor.translateAlternateColorCodes('&', placeholder),
                                15, 15, 15);
                    } else {
                        p.sendTitle(ChatColor.translateAlternateColorCodes('&', titleHeader), ChatColor.translateAlternateColorCodes('&', titleFooter),
                                15, 15, 15);
                    }
                    // ELSE IF sendmesssage_gravestone_coords is true send message.
                } else if (sendMessage) {
                    if (message.contains("%coords%")) {
                        String replacement = message.replace("%coords%", "X " + XCoord.get(p) + " Z " + ZCoord.get(p) + " Y " + YCoord.get(p));
                        p.sendMessage(ChatColor.translateAlternateColorCodes('&', replacement));
                    } else {
                        p.sendMessage(ChatColor.translateAlternateColorCodes('&', message));
                    }
                }
            }
        }
    }
}

